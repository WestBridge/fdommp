{% extends "base_body.html" %}

{% block link_1 %}
    <link rel="stylesheet" href="/static/plugins/layer/skin/default/layer.css">
    <link rel="stylesheet" href="/static/plugins/jquery-confirm/jquery-confirm.min.css">
    <link rel="stylesheet" href="/static/plugins/bootstrap-select/bootstrap-select.css">
    <link rel="stylesheet" href="/static/plugins/select2/select2.min.css">
    <link href="/static/plugins/datatable/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="/static/plugins/datatable/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="/static/plugins/datatable/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="/static/plugins/datatable/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="/static/plugins/datatable/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        .on_hide {
            display: none;
        }

        td.details-control {
		    background: url('/static/icon/details_open.png') no-repeat center center;
		    cursor: pointer;
		}
		tr.shown td.details-control {
		    background: url('/static/icon/details_close.png') no-repeat center center;
		}


    </style>

{% endblock %}

{% block body %}
    <section class="content" >
        <div class="row">
            <div class="col-xs-12">

                <div class="box">
                    <div class="box-header">
                      <button  id="add_db" type="button" class="btn btn-primary" onclick="layer_add_db()">add</button>

                    </div>
                </div>

                <div class="box-body">


                    <table id="DatabaseListTable" class="table table-striped table-bordered">
		                      <thead>
		                        <tr>
					                <th class="text-center">详细</th>
					                <th>ID</th>
					                <th>环境类型</th>
					                <th>架构类型</th>
					                <th>业务归属</th>
					                <th>数据库类型</th>
					                <th>数据版本</th>
					                <th>数据库地址</th>
					                <th>账户</th>
					                <th>端口</th>
									<th>标签</th>
									<th>读写类型</th>
									<th class="text-center">操作</th>
		                        </tr>
		                      </thead>
		                      <tbody>

                              </tbody>
                    </table>




                </div>


            </div>
        </div>
    </section>




    <section class="content on_hide" id="add_db_windows">
        <div class="row">
            <div class="col-xs-12">


                <div class="box-body">

                    <form role="form" method="post" id="addDatabase" class="main form-horizontal"  novalidate>
                        <div class="form-group" >
                             <label class="col-sm-2 control-label" >环境类型<span class="required">*</span></label>
                             <div class="col-sm-10">
                                 <select required="required" class="selectpicker form-control" data-live-search="true"  data-size="10" data-width="100%" name="db_env" id="db_env" autocomplete="off">
                                     <option selected="selected" value="">请选择一个项目</option>
                                    <option value="beta" name="db_env" >测试</option>
                                    <option value="ga" name="db_env">生产</option>
                                 </select>
                             </div>
                        </div>
                        <div class="form-group" >
                             <label class="col-sm-2 control-label" >架构类型<span class="required">*</span></label>
                             <div class="col-sm-10">
                                 <select required="required" class="selectpicker form-control" data-live-search="true"  data-size="10" data-width="100%" name="db_mode" id="db_mode" autocomplete="off">
                                     <option selected="selected" value="">请选择一个项目</option>
                                    <option value="single" name="db_mode" >单例</option>
                                    <option value="ms" name="db_mode" >主从</option>
                                    <option value="pxc" name="db_mode" >PXC</option>
                                    <option value="master" name="db_mode" >主库</option>
                                 </select>
                             </div>
                        </div>
                        <input class="form-control"  type="hidden" value="mysql"  name="db_type" />
                        <div class="form-group">
                             <label class="col-sm-2 control-label" > 所属项目<span class="required">*</span></label>
                             <div class="col-sm-10">
                                  <select required="required" class="selectpicker form-control" data-live-search="true"  data-size="10" data-width="100%"  id="db_business"  onchange="javascript:oBtBusinessSelect();" autocomplete="off">
                                        <option selected="selected" value="">请选择一个项目</option>
                                  </select>
                             </div>
                        </div>
                        <div class="form-group" >
                             <label required="required" class="col-sm-2 control-label" >数据库IP<span class="required">*</span></label>
                             <div class="col-sm-10">
                                 <select class="selectpicker form-control" data-live-search="true"  data-size="10" data-width="100%" name="db_assets_id" id="db_assets_id" autocomplete="off">
                                    <option selected="selected" value="">请选择服务器</option>
                                 </select>
                             </div>
                        </div>
                        <div class="form-group">
                             <label class="col-sm-2 control-label" > 读写类型<span class="required">*</span></label>
                             <div class="col-sm-10">
                                 <select class="selectpicker form-control" data-live-search="true"  data-size="10" data-width="100%" name="db_rw"  id="db_rw" autocomplete="off">
                                     <option selected="selected" value="">请选择一个项目</option>
                                    <option selected="selected" value="read">只读</option>
                                    <option  value="write">写入</option>
                                    <option  value="r/w">读写</option>
                                 </select>
                             </div>
                        </div>
                        <div class="item form-group" >
                             <label  class="col-sm-2 control-label" > 数据库类型<span class="required">*</span></label>
                             <div class="col-sm-10">
                                <input class="form-control" type="text" value="MySQL" placeholder="不能为空" name="db_type" id="db_type"  required/>
                             </div>
                        </div>
                        <div class="item form-group" >
                             <label  class="col-sm-2 control-label" > 数据库版本<span class="required">*</span></label>
                             <div class="col-sm-10">
                                <input class="form-control" type="text" value="" placeholder="不能为空" name="db_name" id="db_version"  required/>
                             </div>
                        </div>
                        <div class="item form-group" >
                             <label  class="col-sm-2 control-label" > 账户<span class="required">*</span></label>
                             <div class="col-sm-10">
                                <input class="form-control" type="text" value="" placeholder="不能为空" name="db_user" id="db_user" required/>
                             </div>
                        </div>

                        <div class="item form-group" >
                             <label  class="col-sm-2 control-label" > 端口<span class="required">*</span></label>
                             <div class="col-sm-10">
                                <input class="form-control" type="text"   value="" placeholder="不能为空" name="db_port" id="db_port" required/>
                             </div>
                        </div>

                        <div class="item form-group" >
                             <label  class="col-sm-2 control-label" > 密码<span class="required">*</span></label>
                             <div class="col-sm-10">
                                <input class="form-control" type="password"   value="" placeholder="不能为空" name="db_passwd" id="db_passwd" required/>
                             </div>
                        </div>
                        <div class="form-group" >
                             <label  class="col-sm-2 control-label" > 备注</label>
                             <div class="col-sm-10">
                                <input class="form-control" type="text"  value="" placeholder="第二个分库" name="db_mark" id="db_mark" />
                             </div>
                        </div>
                        <legend></legend>
                        <div class="form-group">
                            <label class="col-sm-4 control-label"></label>
{#                            <button type="reset" class="btn btn-default btn-group-sm">取消</button>#}
                            <button type="button" class="btn btn-default btn-group-sm" value="" id="save_database_config"></button>
                        </div>
                    </form>



                </div>


            </div>
        </div>
    </section>


    <section class="content on_hide" id="relevance_db_windows">
        <div class="row">
            <div class="col-xs-12">
                <div class="box-body">
                    <h4 class="modal-title" id="databaseImportModalLabel">导入数据库</h4>
                    <div class="input-group col-xs-12">
					        <div class="input-group-btn">
					            <button type="button" class="btn btn-default" data-dismiss="modal" disabled>数据库名称</button>
					        </div>
					        <input id="server_database_input" type="text" class="form-control" placeholder="输入数据库名称">
							<span class="input-group-btn">
							    <button class="btn btn-success" id="server_database_submit" value="">添加</button>
							</span>
                    </div>
                    <table width="100%" class="table table-striped table-bordered" id="server_database_list">
                               <thead>
									<tr>
										<th>名称</th>
										<th>大小(MB)</th>
										<th class="text-center">操作</th>
									</tr>
                               </thead>
                               <tbody>
                               </tbody>
                    </table>

                </div>
            </div>
        </div>
    </section>










{% endblock %}


{% block js %}
    <script src="/static/plugins/layer/layer.js"></script>
    <script src="/static/plugins/jquery-confirm/jquery-confirm.min.js"></script>
    <script src="/static/plugins/select2/select2.full.min.js"></script>
    <script src="/static/plugins/datatable/datatables.net/js/jquery.dataTables.min.js"></script>
	<script src="/static/plugins/datatable/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="/static/plugins/datatable/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/static/plugins/datatable/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="/static/plugins/datatable/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="/static/plugins/datatable/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="/static/plugins/datatable/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="/static/plugins/bootstrap-select/bootstrap-select.js"></script>
    <script src="/static/layui/layui.all.js"></script>
    <script>
        var language =  {
            "sProcessing" : "处理中...",
            "sLengthMenu" : "显示 _MENU_ 项结果",
            "sZeroRecords" : "没有匹配结果",
            "sInfo" : "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
            "sInfoEmpty" : "显示第 0 至 0 项结果，共 0 项",
            "sInfoFiltered" : "(由 _MAX_ 项结果过滤)",
            "sInfoPostFix" : "",
            "sSearch" : "搜索: ",
            "sUrl" : "",
            "sEmptyTable" : "表中数据为空",
            "sLoadingRecords" : "载入中...",
            "sInfoThousands" : ",",
            "oPaginate" : {
                "sFirst" : "首页",
                "sPrevious" : "上页",
                "sNext" : "下页",
                "sLast" : "末页"
            },
            "oAria" : {
                "sSortAscending" : ": 以升序排列此列",
                "sSortDescending" : ": 以降序排列此列"
            }
        }








        $(function() {


            if($('#db_business').length){
                $.ajax({
                    async : true,
                    url:'/api/asset/business/tree/', //请求地址
                    type:"GET",  //提交类似
                    success:function(response){
                        var binlogHtml = '<select required="required" class="selectpicker form-control" data-live-search="true"  data-size="10" data-width="100%" name="db_business"  id="db_business" autocomplete="off" ><option selected="selected" value="">请选择一个进行操作</option>'
                        var selectHtml = '';
                        for (var i=0; i <response.length; i++){
                            selectHtml += '<option value="'+ response[i]["id"] +'">'+ response[i]["paths"] +'</option>'
                        };
                        binlogHtml =  binlogHtml + selectHtml + '</select>';

                        $("#db_business").html(binlogHtml)
                        $("#db_business").selectpicker('refresh');
                    }
                });
            }


            if ($("#DatabaseListTable").length) {
                var response = requests('get','/api/db/manage/',{})
                console.log('rrr:',response)
                {#makeDatabaseSelect("db_server",response)#}
                var columns = [
                                {
                                    "className":      'details-control',
                                    "orderable":      false,
                                    "data":           null,
                                    "defaultContent": ''
                                },
                                { "data": "id" },
                                { "data": "db_env" },
                                { "data": "db_mode" },
                                { "data": "db_business_paths" },
                                { "data": "db_type"},
                                { "data": "db_version"},
                                { "data": "ip"},
                                { "data": "db_user"},
                                { "data": "db_port"},
                                { "data": "db_mark"},
                                { "data": "db_rw"},
                        ]

               var columnDefs = [
                                    {
                                    targets: [12],
                                    render: function(data, type, row, meta) {
                                        return '<div class="btn-group  btn-group-xs">' +
                                                   '<button type="button" name="btn-database-link" value="'+ row.id +'" class="btn btn-default"  aria-label="Justify"><span class="glyphicon glyphicon glyphicon-zoom-in" aria-hidden="true"></span>' +
                                                   '</button>' +
                                                   '<button type="button" name="btn-database-edit" value="'+ row.id +'" class="btn btn-default"  aria-label="Justify"><span class="fa fa-edit" aria-hidden="true"></span>' +
                                                   '</button>' +
                                                   '<button type="button" name="btn-database-import" value="'+ row.id +'" class="btn btn-default"  aria-label="Justify"  data-toggle="modal" data-target=".bs-example-modal-database-import"><span class="fa fa-database" aria-hidden="true"></span>' +
                                                   '</button>' +
                                                   '<button type="button" name="btn-database-delete" value="'+ row.id +'" class="btn btn-default" aria-label="Justify"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span>' +
                                                   '</button>' +
                                                   '</div>';
                                    },
                                    "className": "text-center",
                                    },
                                  ]

                var buttons = [{
                    text: '<span class="fa fa-plus"></span>',
                    className: "btn-xs",
                    action: function ( e, dt, node, config ) {
                        $("#save_database_config").val("");
                        $("#save_database_config").text("添加");
                    }
                }]
                var table = $('#DatabaseListTable').DataTable({
                            "dom": "Bfrtip",
                            "buttons":[],
                            "bScrollCollapse": false,
                            "bRetrieve": true,
                            "destroy": true,
                            "data":	response,
                            "columns": columns,
                            "columnDefs" :columnDefs,
                            "language" : language,
                            "order": [[ 0, "ase" ]],
                            "autoWidth": false
                });
            }

            $('#DatabaseListTable tbody').on('click', 'td.details-control', function () {
                var dataList = [];
                var tr = $(this).closest('tr');
                var row = table.row( tr );
                dbId = row.data()["id"];
                $.ajax({
                    url : "/api/db/status/"+dbId+"/",
                    type : "post",
                    async : false,
                    data : {"id":dbId},
                    dataType : "json",
                    success : function(result) {
                        dataList = result.data;
                    }
                });
                if ( row.child.isShown() ) {
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    row.child( format(dataList) ).show();
                    tr.addClass('shown');
                }
            });


            $('#DatabaseListTable tbody').on('click',"button[name='btn-database-edit']",function(){
                layer_edit_db()
                var btnObj = $(this);
                btnObj.attr('disabled',true);
                var vIds = $(this).val();
                $("#save_database_config").val(vIds);
                $("#save_database_config").text("修改");
                $.ajax({
                    url : '/api/db/manage/'+ vIds + '/' ,
                    type : 'get',
                    async:false,
                    success : function(response){
                        btnObj.removeAttr('disabled');
                        BusinessAssetsSelect(response["db_business"],response["db_assets_id"])
                        DynamicSelect("db_env",response["db_env"])
                        DynamicSelect("db_business",response["db_business"])
                        DynamicSelect("db_mode",response["db_mode"])
                        DynamicSelect("db_rw",response["db_rw"])
                        $("#db_version").val(response["db_version"]);
                        $("#db_type").val(response["db_type"]);
                        $("#db_user").val(response["db_user"]);
                        $("#db_port").val(response["db_port"]);
                        $("#db_mark").val(response["db_mark"]);
                        $('.selectpicker').selectpicker('refresh');
                    },
                    error:function(response){
                        btnObj.removeAttr('disabled');
                    }
                });
              });


            $('#DatabaseListTable tbody').on('click',"button[name='btn-database-import']",function(){
                layer_relevance_db()
                var vIds = $(this).val();
                var td = $(this).parent().parent().parent().find("td")
                let server = td.eq(7).text()
                let port = td.eq(9).text()
                $("#databaseImportModalLabel").html('<h4 class="modal-title" id="databaseImportModalLabel"><u class="red">'+ server + ':' + port +'</u> 导入数据库</h4>')
                $("#server_database_submit").val(vIds)
                if ($('#server_database_list').hasClass('dataTable')) {
                    dttable = $('#server_database_list').dataTable();
                    dttable.fnClearTable();
                    dttable.fnDestroy();
                }
                makeServerDatabaseTableList(vIds)
              });


            $('#DatabaseListTable tbody').on('click',"button[name='btn-database-delete']",function(){
                var vIds = $(this).val();
                var td = $(this).parent().parent().parent().find("td")
                var port = td.eq(9).text()
                var server = td.eq(7).text()
                $.confirm({
                    title: '删除确认',
                    content:  '<strong>服务器</strong><code>' + server + ':' + port + '</code>数据库配置',
                    type: 'red',
                    buttons: {
                             删除: function () {
                        $.ajax({
                            cache: true,
                            type: "DELETE",
                            url:'/api/db/manage/'+ vIds + '/' ,
                            error: function(response) {
                                new PNotify({
                                    title: 'Ops Failed!',
                                    text: "删除失败",
                                    type: 'error',
                                    styling: 'bootstrap3'
                                });
                            },
                            success: function(response) {
                                new PNotify({
                                    title: 'Success!',
                                    text: "删除成功",
                                    type: 'success',
                                    styling: 'bootstrap3'
                                });
                                RefreshTable('#DatabaseListTable', '/api/db/manage/')
                            }
                        });
                        },
                        取消: function () {
                            return true;
                        },
                    }
                });
            });





            $('#server_database_list tbody').on('click',"button[name='btn-server-database-delete']",function(){
                var vIds = $(this).val();
                var td = $(this).parent().parent().parent().find("td")
                let db_server = $("#server_database_submit").val()
                $.confirm({
                    title: '删除确认',
                    content:  '<strong>数据库</strong><code>' + td.eq(0).text() + '</code>',
                    type: 'red',
                    buttons: {
                             删除: function () {
                        $.ajax({
                            cache: true,
                            type: "DELETE",
                            url:'/api/db/server/'+ db_server +'/db/'+ vIds +'/' ,
                            error: function(response) {
                                new PNotify({
                                    title: 'Ops Failed!',
                                    text: "删除失败",
                                    type: 'error',
                                    styling: 'bootstrap3'
                                });
                            },
                            success: function(response) {
                                new PNotify({
                                    title: 'Success!',
                                    text: "删除成功",
                                    type: 'success',
                                    styling: 'bootstrap3'
                                });
                                if ($('#server_database_list').hasClass('dataTable')) {
                                    dttable = $('#server_database_list').dataTable();
                                    dttable.fnClearTable();
                                    dttable.fnDestroy();
                                }
                                makeServerDatabaseTableList(db_server)
                            }
                        });
                        },
                        取消: function () {
                            return true;
                        },
                    }
                });
              });



            $("#server_database_submit").on('click', function() {
                var vIds = $(this).val();
                let dbname = $("#server_database_input").val()
                let url = "/api/db/server/"+vIds+"/list/"
                if (vIds.length && dbname.length){
                    $.ajax({
                        type: "POST",
                        url:url,
                        data:{
                            "db_name":dbname,
                        },
                        error: function(response) {
                            new PNotify({
                                title: 'Ops Failed!',
                                text: response.responseText,
                                type: 'error',
                                styling: 'bootstrap3'
                            });
                        },
                        success: function(response) {
                            new PNotify({
                                title: 'Success!',
                                text: '添加成功',
                                type: 'success',
                                styling: 'bootstrap3'
                            });
                            RefreshServerDatabaseTable('#server_database_list', url)
                        }
                    });
                }else{
                    $.confirm({
                        title: '<strong>警告</strong>',
                        typeAnimated: true,
                        content: "没有选择数据库服务器，或者没有输入数据库名称~",
                        type: 'red'
                    });
                }

            });







        })


        function makeServerDatabaseTableList(vIds){
            var columns = [
                           {"data": "db_name"},
                           {
                               "data": "db_size",
                               "defaultContent": ""
                           },
                           ]
           var columnDefs = [
                                {
                                targets: [2],
                                render: function(data, type, row, meta) {
                                    return '<div class="btn-group  btn-group-xs">' +
                                               '<button type="button" name="btn-server-database-delete" value="'+ row.id +'" class="btn btn-default" aria-label="Justify"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span>' +
                                               '</button>' +
                                               '</div>';
                                },
                                "className": "text-center",
                                },
                              ]
            var buttons = [{
                text: '<span class="fa fa-plus"></span>',
                className: "btn-xs",
                action: function ( e, dt, node, config ) {

                }
            }]
            InitServerDatabaseDataTable('server_database_list',"/api/db/server/"+vIds+"/list/",buttons,columns,columnDefs);
        };


        function InitServerDatabaseDataTable(tableId,url,buttons,columns,columnDefs){
            var data = requests('get',url)
            oOverviewTable =$('#'+tableId).dataTable(
                  {
                        "dom": "Bfrtip",
                        "buttons":buttons,
                        "bScrollCollapse": false,
                        "bRetrieve": true,
                        "destroy": true,
                        "data":	data,
                        "columns": columns,
                        "columnDefs" :columnDefs,
                        "language" : language,
                        "order": [[ 0, "ase" ]],
                        "autoWidth": true
                    });
        };


        function RefreshServerDatabaseTable(tableId, urlData){
            $.getJSON(urlData, null, function( dataList ){
              table = $(tableId).dataTable();
              oSettings = table.fnSettings();

              table.fnClearTable(this);

              for (var i=0; i<dataList.length; i++)
              {
                table.oApi._fnAddData(oSettings, dataList[i]);
              }

              oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
              table.fnDraw();

            });
        }







        function DynamicSelect(ids,value){
            $("#" + ids +" option").each(function(){
                $(this).prop("selected",false);
            })
            $("#" + ids +" option[value='" + value +"']").prop("selected",true);
        }

        function RefreshTable(tableId, urlData){
            $.getJSON(urlData, null, function( dataList )
            {
            table = $(tableId).dataTable();
            oSettings = table.fnSettings();

            table.fnClearTable(this);

            for (var i=0; i<dataList.length; i++)
            {
              table.oApi._fnAddData(oSettings, dataList[i]);
            }

            oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
            table.fnDraw();

            });
        }






        function BusinessAssetsSelect(node,ids){
               if ( node > 0){
                    $.ajax({
                        dataType: "JSON",
                        url:'/api/asset/server/', //请求地址
                        type:"GET",  //提交类似
                        success:function(response){
                            var binlogHtml = '<select class="selectpicker" name="db_assets_id" id="db_assets_id" required><option  name="db_assets_id" value="">请选择服务器</option>'
                            var selectHtml = '';
                            for (var i=0; i <response.length; i++){
                                if(ids==response[i]['asset']["id"]){
                                    selectHtml += '<option selected=selected name="db_assets_id" value="'+ response[i]['asset']["id"] +'">' + response[i]["asset"]["manage_ip"] + '</option>'
                                }else{
                                    selectHtml += '<option name="db_assets_id" value="'+ response[i]['asset']["id"] +'">' + response[i]["asset"]["manage_ip"] + '</option>'
                                }

                            };
                            binlogHtml =  binlogHtml + selectHtml + '</select>';
                            $("#db_assets_id").html(binlogHtml)
                            $('.selectpicker').selectpicker('refresh');
                        },
                    });
               }
        }









        function oBtBusinessSelect() {

           $('#db_host').empty();
           var obj = document.getElementById("db_business");
           var index = obj.selectedIndex;
           var businessId = obj.options[index].value;


           {#var sel_obj = $("#db_business").select2('val');#}

           if ( businessId > 0){
                $.ajax({
                    dataType: "JSON",
                    url:'/api/asset/server/', //请求地址
                    type:"GET",  //提交类似
                    success:function(response){
                        var binlogHtml = '<select class="form-control select2" name="db_assets_id" id="db_assets_id" required><option  name="db_assets_id" value="">请选择服务器</option>'
                        var selectHtml = '';
                        for (var i=0; i <response.length; i++){
                             selectHtml += '<option name="db_assets_id" value="'+ response[i]["asset"]['id'] +'">' + response[i]["asset"]["manage_ip"] + '</option>'
                        };
                        binlogHtml =  binlogHtml + selectHtml + '</select>';
                        $("#db_assets_id").html(binlogHtml)
                        $('.selectpicker').selectpicker('refresh');
                    },
                });
           }
           else{
               $('#db_service').attr("disabled",true);
           }
        }


        $('#save_database_config').on('click', function() {
            var btnObj = $(this);
            btnObj.attr('disabled',true);
            var vIds = $(this).val();
            var form = document.getElementById('addDatabase');
            for (var i = 0; i < form.length; ++i) {
                var name = form[i].name;
                var value = form[i].value;
                if (value.length == 0 && name.length >0 ){
                    $("[name='"+ name +"']").parent().addClass("has-error");
                    new PNotify({
                        title: 'Warning!',
                        text: '请注意必填项不能为空~',
                        type: 'warning',
                        styling: 'bootstrap3'
                    });
                    btnObj.removeAttr('disabled');
                    return false;
                }else if (value.length > 0){
                    $("[name='"+ name +"']").parent().removeClass("has-error");
                }

            };
            if (vIds > 0){  //编辑
                $.ajax({
                    url:'/api/db/manage/'+ vIds +'/', //请求地址
                    type:"PUT",  //提交类似
                    contentType : "application/json",
                    data:JSON.stringify({
                        "db_env":$("#db_env option:selected").val(),
                        "db_type":$("#db_type").val(),
                        "db_version":$("#db_version").val(),
                        "db_business":$("#db_business option:selected").val(),
                        "db_assets_id":$("#db_assets_id option:selected").val(),
                        "db_user":$("#db_user").val(),
                        "db_passwd":$("#db_passwd").val(),
                        "db_port":$("#db_port").val(),
                        "db_mark":$("#db_mark").val(),
                        "db_rw":$("#db_rw").val(),
                        "db_mode":$("#db_mode option:selected").val(),
                    }),
                    success:function(response){
                        btnObj.removeAttr('disabled');

                        layer.close(layer.index);
                        RefreshTable('#DatabaseListTable', '/api/db/manage/')

                    },
                    error:function(response){
                        btnObj.removeAttr('disabled');
                        new PNotify({
                               title: 'Ops Failed!',
                               text: response.responseText,
                               type: 'error',
                               styling: 'bootstrap3'
                           });
                    }
                })
            }else{  //新增
                $.ajax({
                    url:'/api/db/manage/', //请求地址
                    type:"POST",  //提交类似
                    contentType : "application/json",
                    data:JSON.stringify({
                        "db_env":$("#db_env option:selected").val(),
                        "db_type":$("#db_type").val(),
                        "db_version":$("#db_version").val(),
                        "db_business":$("#db_business option:selected").val(),
                        "db_assets_id":$("#db_assets_id option:selected").val(),
                        "db_user":$("#db_user").val(),
                        "db_passwd":$("#db_passwd").val(),
                        "db_port":$("#db_port").val(),
                        "db_mark":$("#db_mark").val(),
                        "db_rw":$("#db_rw").val(),
                        "db_mode":$("#db_mode option:selected").val(),
                    }),
                    success:function(response){
                        btnObj.removeAttr('disabled');

                        layer.close(layer.index);
                        RefreshTable('#DatabaseListTable', '/api/db/manage/')

                    },
                    error:function(response){
                        btnObj.removeAttr('disabled');
                        new PNotify({
                               title: 'Ops Failed!',
                               text: response.responseText,
                               type: 'error',
                               styling: 'bootstrap3'
                           });
                    }
                })
            }

        });








        function layer_add_db(){

            var ids = ['db_env','db_mode', 'db_business', 'db_assets_id', 'db_rw']
            for (var i=0;i<ids.length;i++){
                let id = ids[i]

                $("#" + id +" option[value='']").prop("selected",true);
            }
            $('.selectpicker').selectpicker('refresh');

            $("#db_type,#db_version,#db_user,#db_port,#db_passwd,#db_mark,#save_database_config").val('')
            $("#save_database_config").text('添加')
            layer.open({
                    type: 1,
                    title: '修改主机信息',
                    closeBtn: 1,
                    zIndex:33,
                    area: ['800px', '400px'],
                    shadeClose: true, //点击遮罩关闭
                    content: $('#add_db_windows'),
                })


        };

        function layer_edit_db(){
            $('#db_passwd').val('')
            layer.open({
                    type: 1,
                    title: '修改主机信息',
                    closeBtn: 1,
                    zIndex:33,
                    area: ['800px', '400px'],
                    shadeClose: true, //点击遮罩关闭
                    content: $('#add_db_windows'),
                })
        };

        function layer_relevance_db(){
            layer.open({
                    type: 1,
                    title: '修改主机信息',
                    closeBtn: 1,
                    zIndex:33,
                    area: ['800px', '400px'],
                    shadeClose: true, //点击遮罩关闭
                    content: $('#relevance_db_windows'),
                })
        };






        /*
        $("#db_business").select2({
            placeholder: 'host',
            multiple:false,
            language: "zh-CN",
            allowClear:true,
            closeOnSelect:false,
            theme: "classic",


        });
        */

        function requests(method,url,data){
            var ret = '';
            $.ajax({
                async:false,
                url:url, //请求地址
                type:method,  //提交类似
                success:function(response){
                     ret = response;
                },
                error:function(data){
                    ret = {};
                }
            });
            return 	ret
        }


        function format ( data ) {
            /* base */
            var trBaseHtml = '';
            for (var i=0; i <data['base'].length; i++){
                if (i%6 == 0){
                    trBaseHtml += '</tr>';
                }
                if (data['base'][i]["value"] == 'ON'){
                    trBaseHtml += '<td>'+ data['base'][i]["name"] +':</td>'+ '<td><font color="green">'+ data['base'][i]["value"] +'</font></td>'
                }
                else if (data['base'][i]["value"] == 'OFF'){
                    trBaseHtml += '<td>'+ data['base'][i]["name"] +':</td>'+ '<td><font color="red">'+ data['base'][i]["value"] +'</font></td>'
                }
                else{
                    trBaseHtml += '<td>'+ data['base'][i]["name"] +':</td>'+ '<td>'+ data['base'][i]["value"] +'</td>'
                }

            };
            var vBaseHtml = '<div class="row"><div class="col-lg-12"><table class="table table-bordered"><caption>基本信息</caption>'+
                                    '<tr>' + trBaseHtml  + '</tr>' +
                            '</table></div></div>';
            /*  pxc */
            var trPxcHtml = '';
            for (var i=0; i <data['pxc'].length; i++){
                if (data['pxc'][i]["value"] == 'ON'){
                    trPxcHtml += '<tr><td>'+ data['pxc'][i]["name"] +':</td>'+ '<td><font color="green">'+ data['pxc'][i]["value"] +'</font></td></tr>'
                }
                else if (data['pxc'][i]["value"] == 'OFF'){
                    trPxcHtml += '<tr><td>'+ data['pxc'][i]["name"] +':</td>'+ '<td><font color="red">'+ data['pxc'][i]["value"] +'</font></td></tr>'
                }
                else{
                    trPxcHtml += '<tr><td>'+ data['pxc'][i]["name"] +':</td>'+ '<td>'+ data['pxc'][i]["value"] +'</td></tr>'
                }

            };
            var vPXCHmtl = '<div class="col-lg-6"><table class="table table-bordered"><caption>PXC集群信息</caption>'+
                                    trPxcHtml  +
                            '</table></div>';
            /* master */
            var trMasterHtml = '';
            for (var i=0; i <data['master'].length; i++){
                trMasterHtml += '<tr><td>'+ data['master'][i]["name"] +':</td>'+ '<td>'+ data['master'][i]["value"] +'</td></tr>'
            }
            var vMasterHtml = '<div class="col-lg-4"><table class="table table-bordered"><caption>Master信息</caption>'+
                                    '<tr>' + trMasterHtml  +'</tr>'
                              '</table></div>';
            /* slave */
            var trSlaveHtml = '';
            for (var i=0; i <data['slave'].length; i++){
                if (i%4 == 0){
                    trSlaveHtml += '</tr>';
                }
                if (data['slave'][i]["value"] == 'Yes'){
                    trSlaveHtml += '<td>'+ data['slave'][i]["name"] +':</td>'+ '<td><font color="green">'+ data['slave'][i]["value"] +'</font></td>'
                }
                else if (data['slave'][i]["value"] == 'No'){
                    trSlaveHtml += '<td>'+ data['slave'][i]["name"] +':</td>'+ '<td><font color="red">'+ data['slave'][i]["value"] +'</font></td>'
                }
                else{
                    trSlaveHtml += '<td>'+ data['slave'][i]["name"] +':</td>'+ '<td>'+ data['slave'][i]["value"] +'</td>'
                }

            }
            var vSlaveHtml = '<div class="row"><div class="col-lg-12"><table class="table table-bordered"><caption>Slave信息</caption>'+
                                    '<tr>' + trSlaveHtml  +'</tr>'
                              '</table></div></div>';
            /* 汇总 */
            if (data['pxc'].length > 0 && data['master'].length > 5){
                return vBaseHtml + '<div class="row">'  + vPXCHmtl  + vMasterHtml + '</div>';
            }
            else if (data['slave'].length > 0){
                return vBaseHtml  + vSlaveHtml + '</div>';
            }
            else if( data['pxc'].length > 0 ){
                return vBaseHtml + '<div class="row">' + vPXCHmtl + '</div>';
            }
            else if ( data['slave'].length > 0 &&  data['master'].length > 5){
                return vBaseHtml + vSlaveHtml + vMasterHtml + '</div>';
            }
            else if(data['master'].length > 5){
                return vBaseHtml + '<div class="row">' + vMasterHtml + '</div>';
            }
            else{
                return vBaseHtml
            }
        };








    </script>
{% endblock %}